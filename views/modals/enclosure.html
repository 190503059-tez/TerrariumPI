{# Include the modal base html template #}
{% extends "layouts/modal.html" %}

{# Set some variables #}
{% set modal_size = 'modal-xl' %}
{% set modal_type = 'enclosure' %}
{% set modal_form_add_action  = url_for('api:enclosure_add') %}
{% set modal_form_edit_action = url_for('api:enclosure_update',enclosure='_id_') %}
{% set modal_reload_url = url_for('page', page='enclosures') %}

{% block modal_title %} <i class="fas fa-globe" ></i> Enclosure settings {% endblock %}
{% block modal_body %}
<input type="hidden" name="id" id="enclosure_id" value="" disabled="disabled">
<div class="row">
  <div class="col-12 col-sm-6 col-md-6 col-lg-6">
    <div class="form-group">
      <label for="enclosure_name">Naam</label>
      <input type="text" class="form-control" id="enclosure_name" name="name" required="required" placeholder="Enter name">
    </div>
  </div>

  <div class="col-12 col-sm-6 col-md-6 col-lg-6">
    <div class="form-group">
      <label for="image">Image</label>
      <div class="custom-file">
        <input type="hidden" name="image" id="image" value="">
        <input type="file" id="image_upload">
        <label class="custom-file-label" for="image_upload">Choose file</label>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12 col-sm-12 col-md-10 col-lg-10">
    <div class="form-group">
      <label for="enclosure_description">Description</label>
      <textarea class="textarea" id="enclosure_description" name="description" placeholder="Place some text here" style="width: 100%; height: 200px; font-size: 14px; line-height: 18px; border: 1px solid #dddddd; padding: 10px;"></textarea>
    </div>
  </div>

  <div class="col-12 col-sm-2 col-md-2 col-lg-2">
    <div class="form-group">
      <label for="enclosure_doors">Doors</label>
      <div class="select2-primary">
        <select class="select2" id="enclosure_doors" name="doors" size="5" multiple="multiple" data-placeholder="Select available doors" style="width: 100%; height: 100%">
        </select>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block modal_form_javascript_functions %}
{% endblock %}


{% block modal_form_javascript_load %}
  jQuery.get('{{ url_for("api:button_list") }}', function(data) {
    let {{modal_type}}_door_select = {{modal_type}}_form.find('select#enclosure_doors');
    {{modal_type}}_door_select.prop('disabled', false).find('option').remove();

    jQuery.each(data.data,function(counter,item){
      {{modal_type}}_door_select.append(jQuery('<option>').attr('value',item.id).text(item.name));
    });

    // Check if we are in edit mode.... and need to load more data....
    if ('#' != jQuery(event.relatedTarget).attr('href')) {
      // Load the button data
      let url = jQuery(event.relatedTarget).attr('href');

      jQuery.get(url, function(data){
        // Enable the hidden id field
        {{modal_type}}_form.find('input[name="id"]').prop('disabled',false)
        // Change the form url to an PUT (update)
        {{modal_type}}_form.attr({'method' : 'PUT', 'action' : url});

        // Load the button values in the form
        jQuery.each(data,function(key,value) {
          let field = {{modal_type}}_form.find('[name="' + key + '"]');
          if (field.attr('type') == 'checkbox') {
            field.prop('checked',(1 != value)).trigger('change');
            field.prop('checked',(1 == value)).trigger('change');
          } else {
            if ('doors' == key) {
              // Create a new array from the doors array with only the door ids
              value = Array.from(value, door => door.id);
            }
            field.val(value).trigger('change');
          }
        });
        {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
      });
    } else {
      //console.log('Closeing loading div',{{modal_type}}_modal.find('div.loading'));
      {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
    }
  });
{% endblock %}

{% block modal_form_javascript_pre_submit %}

  if (this.elements['image_upload'].files.length >= 1) {
    // Upload a new profile image
    let form_data = new FormData();
    jQuery.each(this.elements['image_upload'].files,function(index,file){
//      let file_extension = file.name.split('.').pop()
      form_data.append('file', file);
    });

    jQuery.ajax({
      url: '{{ url_for('file_upload', root='media') }}',
      type: "POST",
      data: form_data,
      processData: false,
      contentType: false,
      async: false,
      success: function (result) {
        {{modal_type}}_modal.find('input[name="image"]').val(result.file);
        toastr.success('Profile image is uploaded.', 'Upload ok');
      },
      error: function (error) {
        error = error.responseJSON;
        toastr.error(error.message , 'Upload error');
      }
    });
  }

{% endblock %}

{# Include the modal base html template #}
{% extends "layouts/modal.html" %}

{# Set some variables #}
{% set modal_size = 'modal-xl' %}
{% set modal_type = 'playlist' %}
{% set modal_form_add_action  = url_for('api:playlist_add') %}
{% set modal_form_edit_action = url_for('api:playlist_update',playlist='_id_') %}
{% set modal_reload_url = url_for('page', page='playlists') %}

{% block modal_title %}<i class="fas fa-play mr-2" ></i>{{ _('Playlist settings') }}{% endblock %}
{% block modal_body %}
<input type="hidden" name="id" id="playlist_id" value="" disabled="disabled">
<div class="row">
  <div class="col-10 col-sm-10 col-md-8 col-lg-4">
    <div class="form-group">
      <label for="playlist_name">{{ _('Name') }}</label>
      <input type="text" class="form-control" id="playlist_name" name="name" required="required" placeholder="{{ _('Enter a name') }}">
      <small class="text-muted">
        {{ _('Enter a name for this playlist.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('Please enter a name of at least 1 character.') }}
      </div>
    </div>
  </div>
  <div class="col-10 col-sm-10 col-md-8 col-lg-4">
    <div class="form-group">
      <label for="playlist_name">{{ _('Volume') }}</label>
      <input class="form-control range_slider" name="volume" data-slider-value="85" data-slider-min="0" data-slider-max="100" data-slider-step="1" type="text">
      <small class="text-muted">
        {{ _('Select the volume for this playlist.') }}
      </small>
    </div>
  </div>
  <div class="col-10 col-sm-10 col-md-8 col-lg-2">
    <div class="form-group">
      <div class="switch">
        <label for="shuffle" class="d-block">{{ _('Shuffle') }}</label>
        <input type="checkbox" class="switch" id="shuffle" name="shuffle">
        <label for="shuffle" class="mt-1"></label>
      </div>
      <small class="text-muted">
        {{ _('Shuffle this playlist every time it is played.') }}
      </small>
    </div>
  </div>
  <div class="col-10 col-sm-10 col-md-8 col-lg-2">
    <div class="form-group">
      <div class="switch">
        <label for="repeat" class="d-block">{{ _('Repeat') }}</label>
        <input type="checkbox" class="switch" id="repeat" name="repeat">
        <label for="repeat" class="mt-1"></label>
      </div>
      <small class="text-muted">
        {{ _('Play this playlist in repeat mode.') }}
      </small>
    </div>
  </div>
  <div class="col-12 col-sm-12 col-md-12 col-lg-12">
    <div class="form-group">
      <label for="files">{{ _('Audio files') }}</label>
      <select class="select2" id="files" name="files" multiple="multiple" required="required" data-placeholder="{{ _('Select audio files') }}" style="width: 100%;">
      </select>
      <small class="text-muted">
        {{ _('Select all audio files for this playlist.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('Select at least 1 audio file.') }}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block modal_form_javascript_functions %}
{% endblock %}

{% block modal_form_javascript_pre %}
{% endblock %}

{% block modal_form_javascript_load %}
{{modal_type}}_modal.find('.range_slider').bootstrapSlider();

jQuery.get('{{ url_for("api:audiofile_list") }}', function(data) {
    let audio_files_select = {{modal_type}}_form.find('select#files');
    audio_files_select.attr('readonly', false).find('option').remove();

    jQuery.each(data.data,function(counter,item){
      let name = item.name;
      if (item.name.toLowerCase() == 'none - none') {
        name = item.filename.split('/').pop();
      }
      audio_files_select.append(jQuery('<option>').attr('value',item.id).text(name + ' - ' + moment.duration(item.duration,'seconds').humanize()));
    });

    audio_files_select.trigger('change');

    // Check if we are in edit mode.... and need to load more data....
    if ('#' != jQuery(event.relatedTarget).attr('href')) {
      // Load the playlist data
      let url = jQuery(event.relatedTarget).attr('href');

      jQuery.get(url, function(data) {
        // Enable the hidden id field
        {{modal_type}}_form.find('input[name="id"]').prop('disabled',false)
        // Change the form url to an PUT (update)
        {{modal_type}}_form.attr({'method' : 'PUT', 'action' : url});
        // Make hardware type readonly

        // Load the playlist values in the form
        // BUG: Due to the fact that a key called 'length' is in the data, we cannot use directly jQuery.each(data). It crashes on getting the length of the object
        jQuery.each(Object.keys(data), function(counter,key) {
          let value = data[key]
          let field = {{modal_type}}_form.find('[name="' + key + '"]');
          if (field.length > 0) {
            if (field.attr('type') == 'checkbox') {
              field.prop('checked',(1 != value)).trigger('change');
              field.prop('checked',(1 == value)).trigger('change');
            } else {
              field.val(value).trigger('change');
            }
          }
        });
        jQuery.each({{modal_type}}_modal.find('.range_slider'), function(counter, element) {
          jQuery(element).bootstrapSlider('setValue', element.value);
        });
        {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
      });
    } else {
    // {{modal_type}}_modal.find('.range_slider').bootstrapSlider();
      {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
    }
  });
{% endblock %}

{% block modal_form_javascript_pre_submit_formdata %}
{% endblock %}

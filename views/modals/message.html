{# Include the modal base html template #}
{% extends "layouts/modal.html" %}

{# Set some variables #}
{% set modal_size = 'modal-xl' %}
{% set modal_type = 'message' %}
{% set modal_form_add_action  = url_for('api:notification_message_add') %}
{% set modal_form_edit_action = url_for('api:notification_message_update',message='_id_') %}
{% set modal_reload_url = url_for('page', page='notifications') %}

{% block modal_title %}<i class="fas fa-thumbtack mr-2" ></i>{{ _('Message settings') }}{% endblock %}
{% block modal_body %}
<input type="hidden" name="services" id="services" value="">
<input type="hidden" name="id" id="message_id" value="">

<div class="row">
  <div class="col-12 col-sm-6 col-md-4 col-lg-4">
    <div class="form-group">
      <label for="message_type">{{ _('Message type') }}</label>
      <div class="select2-primary">
        <select class="select2" id="message_type" name="type" required="required" data-placeholder="{{ _('Select type') }}" style="width: 100%">
        </select>
      </div>
      <small class="text-muted">
        {{ _('Select the notification message type.') }}
      </small>
    </div>
  </div>
  <div class="col-12 col-sm-12 col-md-4 col-lg-4">
    <div class="form-group">
      <label for="message_title">{{ _('Subject') }}</label>
      <input type="text" class="form-control" id="message_title" name="title" required="required" placeholder="{{ _('Enter a subject') }}">
      <small class="text-muted">
        {{ _('Enter a short subject. You can use placeholder values here.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('The subject cannot be empty.') }}
      </div>
    </div>
  </div>
  <div class="col-10 col-sm-10 col-md-8 col-lg-2">
    <div class="form-group">
      <label for="message_rate_limit">{{ _('Rate limit') }}</label>
      <input type="number" class="form-control" id="message_rate_limit" name="rate_limit" required="required" placeholder="{{ _('Messages per minute') }}">
      <small class="text-muted">
        {{ _('Maximum number of messages per minute for this message. Use 0 for unlimited.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('Enter a valid number.') }}
      </div>
    </div>
  </div>
  <div class="col-10 col-sm-10 col-md-8 col-lg-2 text-center">
    <div class="form-group">
      <div class="switch">
        <label for="service_enabled" class="d-block">{{ _('Enabled') }}</label>
        <input type="checkbox" class="switch" id="service_enabled" name="enabled" checked="checked">
        <label for="service_enabled" class="mt-1"></label>
      </div>
      <small class="text-muted">
        {{ _('Enable/disable this notification message.') }}
      </small>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-8">
    <div class="row">
      <div class="col">
        <div class="form-group">
          <label for="message_message">{{ _('Message') }}</label>
          <textarea class="form-control" id="message_message" name="message" rows="6" placeholder="{{ _('Enter a message') }}" style="width: 100%"></textarea>
          <small class="text-muted">
            {{ _('Enter a message. You can use placeholder values here.') }}
          </small>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="form-group">
          <label for="message_current">{{ _('Services') }}</label>
          <div id="services" style="width: 100%"></div>
          <small class="text-muted">
            {{ _('Select the service to use for this notification message.') }}
          </small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-4">
    <div class="form-group">
      <label for="message_reate_limit">{{ _('Place holders') }}</label>
      <div id="place_holders"></div>
      <small class="text-muted">
        {{ _('List of available placeholders.') }}
      </small>
    </div>
  </div>
</div>
{% endblock %}

{% block modal_form_javascript_functions %}
{% endblock %}

{% block modal_form_javascript_pre %}

{% endblock %}

{% block modal_form_javascript_load %}
let placeholders = {};
jQuery.when(

  jQuery.get('{{ url_for("api:notification_message_types") }}'),
  jQuery.get('{{ url_for("api:notification_service_list") }}'),

).done(function(message_types, services) {
    {{modal_type}}_form.find('input[name="id"]').prop('disabled',true)
    let message_type_select = {{modal_type}}_form.find('select#message_type');
    message_type_select.attr('readonly', false);
    message_type_select.find('option').remove();

    {{modal_type}}_form.find('input#services').val('');

    let placeholder_div = jQuery('#place_holders');
    message_type_select.on('change',function(event){
      // Clear
      placeholder_div.html('');
      jQuery.each(placeholders[this.value],function(placeholder_key,placeholder_value){
        placeholder_div.append(jQuery('<div>').html('<strong>${' + placeholder_key + '}</strong>: ' + placeholder_value));
      });
    });

    jQuery.each(message_types[0].data,function(counter,item){
      message_type_select.append(jQuery('<option>').attr('value',item.type).text(item.name));
      placeholders[item.type] = item.placeholders;
    });

    message_type_select.trigger('change');

    let message_services = {{modal_type}}_form.find('div#services');
    message_services.html('');

    jQuery.each(services[0].data,function(counter,item) {
      let service_icon = jQuery('<button>').data('service',item.id).attr({'type':'button','id':item.id, 'title' : item.name}).addClass('btn btn-app').append(jQuery('<i>').addClass(' text-warning ' + template_sensor_type_icon(item.type)))
        message_services.append(service_icon);
    });

    {{modal_type}}_form.find('button.btn-app').on('click',function() {
      jQuery(this).find('i').toggleClass('active');

      let services = [];
      {{modal_type}}_form.find('button.btn-app').has('i.active').each(function(counter,button){
        services.push(jQuery(button).data('service'))
      });

      {{modal_type}}_form.find('input#services').val(services.join(','));
    });

    // Check if we are in edit mode.... and need to load more data....
    if ('#' != jQuery(event.relatedTarget).attr('href')) {
      // Load the message data
      let url = jQuery(event.relatedTarget).attr('href');

      jQuery.get(url, function(data){
        // Enable the hidden id field
        {{modal_type}}_form.find('input[name="id"]').prop('disabled',false)
        // Change the form url to an PUT (update)
        {{modal_type}}_form.attr({'method' : 'PUT', 'action' : url});
        // Make hardware type readonly
        message_type_select.attr('readonly', true);

        // Load the message values in the form
        jQuery.each(data,function(key,value) {

          if ('services' == key && value != null) {
            for (const [ counter, service ] of Object.entries(value)) {
              {{modal_type}}_form.find('button#' + service.id).trigger('click');
            }
          } else {
            let field = {{modal_type}}_form.find('[name="' + key + '"]');
            if (field.attr('type') == 'checkbox') {
              field.prop('checked',(1 != value)).trigger('change');
              field.prop('checked',(1 == value)).trigger('change');
            } else {
              field.val(value).trigger('change');
            }
          }
        });
        {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
      });
    } else {
      {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
    }
  });
{% endblock %}

{% block modal_form_javascript_pre_submit_formdata %}
{% endblock %}

{# Include the modal base html template #}
{% extends "layouts/modal.html" %}

{# Set some variables #}
{% set modal_size             = 'modal-xl' %}
{% set modal_type             = 'area' %}
{% set modal_form_add_action  = url_for('api:area_add') %}
{% set modal_form_edit_action = url_for('api:area_update',area='_id_') %}
{% set modal_reload_url       = url_for('page', page='enclosures') %}

{% block modal_title %}<i class="fas fa-map mr-2" ></i>{{ _('Area settings') }}{% endblock %}
{% block modal_body %}
<input type="hidden" name="id" id="area_id" value="" disabled="disabled">
<div class="row">
  <div class="col-12 col-sm-4 col-md-4 col-lg-4">
    <div class="form-group">
      <label for="area_enclosure">{{ _('Enclosure') }}</label>
      <div class="select2-primary">
        <select class="select2" id="area_enclosure" name="enclosure" required="required" data-placeholder="{{ _('Select an enclosure') }}" style="width: 100%;">
        </select>
      </div>
      <small class="text-muted">
        {{ _('Select the enclosure where this area belongs to.') }}
      </small>
      <div class="invalid-feedback">
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-4 col-md-4 col-lg-4">
    <div class="form-group">
      <label for="area_type">{{ _('Type') }}</label>
      <div class="select2-primary">
        <select class="select2" id="area_type" name="type" required="required" data-placeholder="{{ _('Select an area type') }}" style="width: 100%;">
        </select>
      </div>
      <small class="text-muted">
        {{ _('Select the type of area. Each type has its own extra options and logic.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('ERROR') }}
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-4 col-md-4 col-lg-4">
    <div class="form-group">
      <label for="area_name">{{ _('Name') }}</label>
      <input type="text" class="form-control" id="area_name" name="name" required="required" placeholder="{{ _('Enter a name for this area.') }}">
      <small class="text-muted">
        {{ _('Enter a name.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('The name cannot be empty.') }}
      </div>
    </div>
  </div>
</div>
<div class="row area_type area_lights">
  <div class="col-12 col-sm-6 col-md-3 col-lg-4">
    <div class="form-group">
      <label for="area_lights_mode">{{ _('Mode') }}</label>
      <select class="select2" id="area_lights_mode" name="mode" required="required" data-placeholder="{{ _('Select a mode') }}" style="width: 100%;">
        <option value="disabled">{{ _('Disabled') }}</option>
        <option value="timer">{{ _('Timer') }}</option>
        <option value="weather">{{ _('Weather day/night') }}</option>
        <option value="weather_inverse">{{ _('Weather night/day') }}</option>
      </select>
      <small class="text-muted">
        {{ _('Select the mode of this area. This will change the timing and duration of the relays.') }}
      </small>
      <div class="invalid-feedback">
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-md-3 col-lg-2">
    <div class="form-group">
      <label for="area_lights_min_day_hours">{{ _('Minimum hours') }}</label>
      <input type="number" step="0.001" min="0" max="24" class="form-control" id="area_lights_min_day_hours" name="min_day_hours" placeholder="{{ _('Enter the minimum amount of hours') }}">
      <small class="text-muted">
        {{ _('The minimum amount of hours that the lights are turned on. This is only valid in weather mode. When the day is shorter then this minimum value, the day will be extended to this minimum value.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('ERROR') }}
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-md-3 col-lg-2">
    <div class="form-group">
      <label for="area_lights_max_day_hours">{{ _('Maximum hours') }}</label>
      <input type="number" step="0.001" min="0" max="24" class="form-control" id="area_lights_max_day_hours" name="max_day_hours" placeholder="{{ _('Enter the maximum amount of hours') }}">
      <small class="text-muted">
        {{ _('The maximum amount of hours that the lights are turned on. This is only valid in weather mode. When the day is longer then this maximum value, the day will be shortened to this maximum value.') }}
      </small>
      <div class="invalid-feedback">

      </div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-md-3 col-lg-2">
    <div class="form-group">
      <label for="area_lights_shift_day_hours">{{ _('Hours shift') }}</label>
      <input type="number" step="0.001" min="-12.0" max="12.0" class="form-control" id="area_lights_shift_day_hours" name="shift_day_hours" placeholder="{{ _('Enter the amount of hours to shift') }}">
      <small class="text-muted">
        {{ _('The amount of time to shift in hours based on the sun rise time. Negative values will make the day start earlier.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('Enter a value between -12 and 12.') }}
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-md-3 col-lg-2">
    <div class="form-group">
      <div class="switch">
        <label for="area_lights_main_lights">{{ _('Main lights') }}</label>
        <input type="checkbox" class="switch" id="area_lights_main_lights" name="main_lights">
        <label for="area_lights_main_lights" class="mt-1"></label>
      </div>
      <small class="text-muted">
        {{ _('Toggle this if this is the main lights for this enclosure. This is used for the light checks in other areas.') }}
      </small>
    </div>
  </div>
</div>
<div class="row area_type area_lights">
  <div class="col">
    <small class="text-muted">
      {{ _('Below you can per select the relays and timer settings per period daytime and nighttime.') }}
    </small>
    <nav class="mb-2">
      <div class="nav nav-tabs" role="tablist"> <a class="nav-item nav-link active" id="home-tab" data-toggle="tab" href="#area_lights_day" role="tab" aria-controls="day" aria-selected="true"><i class="fas fa-sun" ></i> {{ _('Day settings') }}</a> <a class="nav-item nav-link" id="profile-tab" data-toggle="tab" href="#area_lights_night" role="tab" aria-controls="night" aria-selected="false"><i class="fas fa-moon" ></i> {{ _('Night settings') }}</a> </div>
    </nav>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="area_lights_day" role="tabpanel" aria-labelledby="day-tab">
        <div class="row">
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_lights_day_begin">{{ _('Begin time') }}</label>
              <input type="time" class="form-control" id="area_lights_day_begin" name="day_begin" placeholder="{{ _('Enter begin time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled on each day.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="lights_day_end">{{ _('End time') }}</label>
              <input type="time" class="form-control" id="area_lights_day_end" name="day_end" placeholder="{{ _('Enter end time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled off each day.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_lights_day_on_duration">{{ _('On duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_lights_day_on_duration" name="day_on_duration" placeholder="{{ _('On duration') }}">
              <small class="text-muted">
                {{ _('The duration when the relays should be on. If this is shorter then all day, you will get a timer functionality. Enter \'0\' to have a full day.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_lights_day_off_duration">{{ _('Off duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_lights_day_off_duration" name="day_off_duration" placeholder="{{ _('Off duration') }}">
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-12 col-lg-12">
            <div class="form-group">
              <label for="area_lights_day_relays">{{ _('Relays') }}</label>
              <select class="select2" id="area_lights_day_relays" name="day_relays" multiple="multiple" data-placeholder="{{ _('Select relays') }}" style="width: 100%;"> </select>
              <small class="text-muted">
                {{ _('Select the relays to toggle.') }}
              </small>
            </div>
          </div>
        </div>
        <div class="row area_alarm_day_dimmer_settings fuckbs-d-none">
          <div class="col">
            <ul class="nav nav-tabs mb-2" id="area_dimmer_settings_day_relays" role="tablist"> </ul>
          </div>
          <div class="tab-content" id="area_dimmer_settings_day_relays_content"></div>
        </div>
      </div>
      <div class="tab-pane fade" id="area_lights_night" role="tabpanel" aria-labelledby="night-tab">
        <div class="row">
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_lights_night_begin">{{ _('Begin time') }}</label>
              <input type="time" class="form-control" id="area_lights_night_begin" name="night_begin" placeholder="{{ _('Enter begin time') }}">
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="lights_night_end">{{ _('End time') }}</label>
              <input type="time" class="form-control" id="area_lights_night_end" name="night_end" placeholder="{{ _('Enter end time') }}">
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_lights_night_on_duration">{{ _('On duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_lights_night_on_duration" name="night_on_duration" placeholder="{{ _('On duration') }}">
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_lights_night_off_duration">{{ _('Off duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_lights_night_off_duration" name="night_off_duration" placeholder="{{ _('Off duration') }}">
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-12 col-lg-12">
            <div class="form-group">
              <label for="area_lights_night_relays">{{ _('Relays') }}</label>
              <select class="select2" id="area_lights_night_relays" name="night_relays" multiple="multiple" data-placeholder="{{ _('Select relays') }}" style="width: 100%;"> </select>
            </div>
          </div>
        </div>
        <div class="row area_alarm_night_dimmer_settings fuckbs-d-none">
          <div class="col">
            <ul class="nav nav-tabs mb-2" id="area_dimmer_settings_night_relays" role="tablist"> </ul>
          </div>
          <div class="tab-content" id="area_dimmer_settings_night_relays_content"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row area_type area_audio">
  <div class="col-12 col-sm-3 col-md-4 col-lg-4">
    <div class="form-group">
      <label for="area_audio_mode">{{ _('Mode') }}</label>
      <select class="select2" id="area_audio_mode" name="mode" required="required" data-placeholder="{{ _('Select a mode') }}" style="width: 100%;">
        <option value="disabled">{{ _('Disabled') }}</option>
        <option value="main_lights">{{ _('Main lights') }}</option>
        <option value="timer">{{ _('Timer') }}</option>
        <option value="weather">{{ _('Weather day/night') }}</option>
        <option value="weather_inverse">{{ _('Weather night/day') }}</option>
      </select>
      <small class="text-muted">
        {{ _('Select the mode of this area. This will change the timing and duration of the players.') }}
      </small>
      <div class="invalid-feedback">
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-9 col-md-8 col-lg-8">
    <div class="form-group">
      <label for="area_audio_soundcard">{{ _('Sound card') }}</label>
      <select class="select2" id="area_audio_soundcard" name="soundcard" required="required" data-placeholder="{{ _('Select a sound card') }}" style="width: 100%;">
      </select>
      <small class="text-muted">
        {{ _('Select the sound card that is used for this enclosure.') }}
      </small>
      <div class="invalid-feedback">
      </div>
    </div>
  </div>
</div>


<div class="row area_type area_audio">
  <div class="col">
    <small class="text-muted">
      {{ _('Below you can per select the relays and timer settings per period daytime and nighttime.') }}
    </small>
    <nav class="mb-2">
      <div class="nav nav-tabs" role="tablist"> <a class="nav-item nav-link active" id="home-tab" data-toggle="tab" href="#area_audio_day" role="tab" aria-controls="day" aria-selected="true"><i class="fas fa-sun" ></i> {{ _('Day settings') }}</a> <a class="nav-item nav-link" id="profile-tab" data-toggle="tab" href="#area_audio_night" role="tab" aria-controls="night" aria-selected="false"><i class="fas fa-moon" ></i> {{ _('Night settings') }}</a> </div>
    </nav>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="area_audio_day" role="tabpanel" aria-labelledby="day-tab">
        <div class="row">
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_audio_day_begin">{{ _('Begin time') }}</label>
              <input type="time" class="form-control" id="area_audio_day_begin" name="day_begin" placeholder="{{ _('Enter begin time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled on each day.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="audio_day_end">{{ _('End time') }}</label>
              <input type="time" class="form-control" id="area_audio_day_end" name="day_end" placeholder="{{ _('Enter end time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled off each day.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_audio_day_on_duration">{{ _('On duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_audio_day_on_duration" name="day_on_duration" placeholder="{{ _('On duration') }}">
              <small class="text-muted">
                {{ _('The duration when the relays should be on. If this is shorter then all day, you will get a timer functionality. Enter \'0\' to have a full day.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in minutes.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_audio_day_off_duration">{{ _('Off duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_audio_day_off_duration" name="day_off_duration" placeholder="{{ _('Off duration') }}">
              <small class="text-muted">
                {{ _('The duration when the relays should be stay off when switched off. Enter \'0\' to disable.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in minutes.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-12 col-lg-12">
            <div class="form-group">
              <label for="area_audio_day_playlists">{{ _('Playlists') }}</label>
              <select class="select2" id="area_audio_day_playlists" name="day_playlists" multiple="multiple" data-placeholder="{{ _('Select playlists') }}" style="width: 100%;"> </select>
              <small class="text-muted">
                {{ _('Select the playlist(s) to be played.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Select at least 1 playlist.') }}
              </div>
            </div>
          </div>
        </div>
        <div class="row area_alarm_day_dimmer_settings fuckbs-d-none">
          <div class="col">
            <ul class="nav nav-tabs mb-2" id="area_dimmer_settings_day_relays" role="tablist"> </ul>
          </div>
          <div class="tab-content" id="area_dimmer_settings_day_relays_content"></div>
        </div>
      </div>
      <div class="tab-pane fade" id="area_audio_night" role="tabpanel" aria-labelledby="night-tab">
        <div class="row">
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_audio_night_begin">{{ _('Begin time') }}</label>
              <input type="time" class="form-control" id="area_audio_night_begin" name="night_begin" placeholder="{{ _('Enter begin time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled on each night.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="audio_night_end">{{ _('End time') }}</label>
              <input type="time" class="form-control" id="area_audio_night_end" name="night_end" placeholder="{{ _('Enter end time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled off each night.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_audio_night_on_duration">{{ _('On duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_audio_night_on_duration" name="night_on_duration" placeholder="{{ _('On duration') }}">
              <small class="text-muted">
                {{ _('The duration when the players should be on. If this is shorter then all day, you will get a timer functionality. Enter \'0\' to have a full night.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in minutes.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="area_audio_night_off_duration">{{ _('Off duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_audio_night_off_duration" name="night_off_duration" placeholder="{{ _('Off duration') }}">
              <small class="text-muted">
                {{ _('The duration when the players should be stay off when switched off. Enter \'0\' to disable.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in minutes.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-12 col-lg-12">
            <div class="form-group">
              <label for="area_audio_night_playlists">{{ _('Playlists') }}</label>
              <select class="select2" id="area_audio_night_playlists" name="night_playlists" multiple="multiple" data-placeholder="{{ _('Select playlists') }}" style="width: 100%;"> </select>
              <small class="text-muted">
                {{ _('Select the playlist(s) to be played.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Select at least 1 playlist.') }}
              </div>
            </div>
          </div>
        </div>
        <div class="row area_alarm_night_dimmer_settings fuckbs-d-none">
          <div class="col">
            <ul class="nav nav-tabs mb-2" id="area_dimmer_settings_night_relays" role="tablist"> </ul>
          </div>
          <div class="tab-content" id="area_dimmer_settings_night_relays_content"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row area_type area_watertank area_heating area_cooling area_humidity area_co2 area_conductivity area_fertility area_moisture area_ph">
  <div class="col-12 col-sm-6 col-md-3 col-lg-3">
    <div class="form-group">
      <label for="area_watertank_mode">{{ _('Mode') }}</label>
      <select class="select2" id="area_watertank_mode" name="mode" required="required" data-placeholder="{{ _('Select a mode') }}" style="width: 100%;">
        <option value="disabled">{{ _('Disabled') }}</option>
        <option value="main_lights">{{ _('Main lights') }}</option>
        <option value="timer">{{ _('Timer') }}</option>
        <option value="sensors">{{ _('Sensors') }}</option>
        <option value="weather">{{ _('Weather day/night') }}</option>
        <option value="weather_inverse">{{ _('Weather night/day') }}</option>
      </select>
      <small class="text-muted">
        {{ _('Select the mode of this area. This will change the timing and duration of the actions.') }}
      </small>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-md-3 col-lg-3">
    <div class="form-group">
      <label for="area_watertank_sensors">{{ _('Sensors') }}</label>
      <select class="select2" id="area_watertank_sensors" name="sensors" multiple="multiple" data-placeholder="{{ _('Select sensors') }}" style="width: 100%;"> </select>
      <small class="text-muted">
        {{ _('Select sensors to use for sensor based mode.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('Select at least 1 sensor.') }}
      </div>
    </div>
  </div>
  <div class="col col-12 col-sm-6 col-md-2 col-lg-2 area_watertank">
    <div class="form-group">
      <label for="area_watertank_volume">{{ _('Volume') }}</label>
      <input type="number" step="0.001" min="0" class="form-control" id="area_watertank_volume" name="watertank_volume" required="required" placeholder="{{ _('Enter the amount') }}">
      <small class="text-muted">
        {{ _('Enter the volume of the water tank.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('Please enter a minimum value of %s.') % ('0',) }}
      </div>
    </div>
  </div>
  <div class="col col-12 col-sm-6 col-md-2 col-lg-2 area_watertank">
    <div class="form-group">
      <label for="area_watertank_height">{{ _('Height') }}</label>
      <input type="number" step="0.001" min="0" class="form-control" id="area_watertank_height" name="watertank_height" required="required" placeholder="{{ _('Enter the height') }}">
      <small class="text-muted">
        {{ _('Enter the height of the water tank.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('Please enter a minimum value of %s.') % ('0',) }}
      </div>
    </div>
  </div>
  <div class="col col-12 col-sm-6 col-md-2 col-lg-2 area_watertank">
    <div class="form-group">
      <label for="area_watertank_offset">{{ _('Offset') }}</label>
      <input type="number" step="0.001" min="0" class="form-control" id="area_watertank_offset" name="watertank_offset" required="required" placeholder="{{ _('Enter the offset') }}">
      <small class="text-muted">
        {{ _('Enter the offset between sensor and water height.') }}
      </small>
      <div class="invalid-feedback">
        {{ _('Please enter a minimum value of %s.') % ('0',) }}
      </div>
    </div>
  </div>
  <div class="col col-12 col-sm-6 col-md-3 col-lg-3 area_all">
    <div class="form-group">
      <label for="area_day_night_difference">{{ _('Day/night difference') }}</label>
      <input type="number" step="0.001" class="form-control" id="area_day_night_difference" name="day_night_difference" value="0" placeholder="{{ _('Day/night difference') }}">
      <small class="text-muted">
        {{ _('Amount to change between day and night.') }}
      </small>
    </div>
  </div>
  <div class="col col-12 col-sm-6 col-md-3 col-lg-3 area_all">
    <div class="form-group">
      <label for="area_day_night_source">{{ _('Day/night source') }}</label>
      <select class="select2" id="area_day_night_source" name="day_night_source" data-placeholder="{{ _('Select a day/night source') }}" style="width: 100%;">
        <option value="lights">{{ _('Lights') }}</option>
        <option value="weather">{{ _('Weather') }}</option>
      </select>
      <small class="text-muted">
        {{ _('Select source when it is \'day\'.') }}
      </small>
    </div>
  </div>
</div>
<div class="row area_type area_watertank area_heating area_cooling area_humidity area_co2 area_conductivity area_fertility area_moisture area_ph">
  <div class="col">
    <nav class="mb-2">
      <div class="nav nav-tabs" role="tablist">
        <a class="nav-item nav-link active" id="low-tab" data-toggle="tab" href="#area_alarm_low" role="tab" aria-controls="low" aria-selected="true">
          <i class="fas fa-battery-empty" ></i> {{ _('Low alarm') }}</a>
        <a class="nav-item nav-link" id="high-tab" data-toggle="tab" href="#area_alarm_high" role="tab" aria-controls="high" aria-selected="false">
          <i class="fas fa-battery-full" ></i> {{ _('High alarm') }}</a>
        <a class="nav-item nav-link" id="variation-tab" data-toggle="tab" href="#area_variation" role="tab" aria-controls="high" aria-selected="false">
          <i class="fas fa-exchange-alt" ></i> {{ _('Variation') }}</a>
      </div>
    </nav>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="area_alarm_low" role="tabpanel" aria-labelledby="low-tab">
        <div class="row">
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_low_begin">{{ _('Begin time') }}</label>
              <input type="time" class="form-control" id="area_alarm_low_begin" name="low_begin" placeholder="{{ _('Enter begin time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled on each day.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="alarm_low_end">{{ _('End time') }}</label>
              <input type="time" class="form-control" id="area_alarm_low_end" name="low_end" placeholder="{{ _('Enter end time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled off each day.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_low_on_duration">{{ _('On duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_alarm_low_on_duration" name="low_on_duration" placeholder="{{ _('On duration') }}">
              <small class="text-muted">
                {{ _('The duration when the relays should be on. If this is shorter then all day, you will get a timer functionality. Enter \'0\' to have a full night.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in minutes.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_low_off_duration">{{ _('Off duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_alarm_low_off_duration" name="low_off_duration" placeholder="{{ _('Off duration') }}">
              <small class="text-muted">
                {{ _('The duration when the relays should be stay off when switched off. Enter \'0\' to disable.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in minutes.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_low_power_on_time">{{ _('Power on time') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_alarm_low_power_on_time" name="low_power_on_time" placeholder="{{ _('Power on time') }}">
              <small class="text-muted">
                {{ _('The duration in seconds to toggle on the relay.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in seconds.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_low_settle_time">{{ _('Settle time') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_alarm_low_settle_time" name="low_settle_time" placeholder="{{ _('Settle time') }}">
              <small class="text-muted">
                {{ _('The duration in seconds between two actions.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in seconds.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_low_light_status">{{ _('Light status') }}</label>
              <select class="select2" id="area_alarm_low_light_status" name="low_light_status" data-placeholder="{{ _('Select a state') }}" style="width: 100%;">
                <option value="ignore">{{ _('Ignored') }}</option>
                <option value="on">{{ _('On') }}</option>
                <option value="off">{{ _('Off') }}</option>
              </select>
              <small class="text-muted">
                {{ _('Select the lights status.') }}
              </small>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_low_door_status">{{ _('Door status') }}</label>
              <select class="select2" id="area_alarm_low_door_status" name="low_door_status" data-placeholder="{{ _('Select a state') }}" style="width: 100%;">
                <option value="ignore">{{ _('Ignored') }}</option>
                <option value="open">{{ _('Open') }}</option>
                <option value="closed">{{ _('Closed') }}</option>
              </select>
              <small class="text-muted">
                {{ _('Select the door status.') }}
              </small>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_low_trigger_threshold">{{ _('Alarm threshold') }}</label>
              <input type="number" step="1" min="0" class="form-control" id="area_alarm_low_trigger_threshold" value="0" name="low_trigger_threshold" placeholder="{{ _('Threshold') }}">
              <small class="text-muted">
                {{ _('Enter the amount of alarms before action take place.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Please enter a minimum value of %s.') % ('0',) }}
              </div>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="area_alarm_low_relays">{{ _('Relays') }}</label>
              <select class="select2" id="area_alarm_low_relays" name="low_relays" multiple="multiple" data-placeholder="{{ _('Select relays') }}" style="width: 100%;"> </select>
              <small class="text-muted">
                {{ _('Select the relays to toggle.') }}
              </small>
            </div>
          </div>
        </div>
        <div class="row area_alarm_low_dimmer_settings fuckbs-d-none">
          <div class="col">
            <ul class="nav nav-tabs mb-2" id="area_dimmer_settings_low_relays" role="tablist"> </ul>
            <div class="tab-content" id="area_dimmer_settings_low_relays_content"> </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="area_alarm_high" role="tabpanel" aria-labelledby="high-tab">
        <div class="row">
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_high_begin">{{ _('Begin time') }}</label>
              <input type="time" class="form-control" id="area_alarm_high_begin" name="high_begin" placeholder="{{ _('Enter begin time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled on each night.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="alarm_high_end">{{ _('End time') }}</label>
              <input type="time" class="form-control" id="area_alarm_high_end" name="high_end" placeholder="{{ _('Enter end time') }}">
              <small class="text-muted">
                {{ _('The time of the day when the relays are toggled off each night.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid time.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_high_on_duration">{{ _('On duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_alarm_high_on_duration" name="high_on_duration" placeholder="{{ _('On duration') }}">
              <small class="text-muted">
                {{ _('The duration when the relays should be on. If this is shorter then all day, you will get a timer functionality. Enter \'0\' to have a full night.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in minutes.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_high_off_duration">{{ _('Off duration') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_alarm_high_off_duration" name="high_off_duration" placeholder="{{ _('Off duration') }}">
              <small class="text-muted">
                {{ _('The duration when the relays should be stay off when switched off. Enter \'0\' to disable.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in minutes.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_high_power_on_time">{{ _('Power on time') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_alarm_high_power_on_time" name="high_power_on_time" placeholder="{{ _('Power on time') }}">
              <small class="text-muted">
                {{ _('The duration in seconds to toggle on the relay.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in seconds.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_high_settle_time">{{ _('Settle time') }}</label>
              <input type="number" step="0.1" min="0" class="form-control" id="area_alarm_high_settle_time" name="high_settle_time" placeholder="{{ _('Settle time') }}">
              <small class="text-muted">
                {{ _('The duration in seconds between two actions.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Enter a valid duration in seconds.') }}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_high_light_status">{{ _('Light status') }}</label>
              <select class="select2" id="area_alarm_high_light_status" name="high_light_status" data-placeholder="{{ _('Select a state') }}" style="width: 100%;">
                <option value="ignore">{{ _('Ignored') }}</option>
                <option value="on">{{ _('On') }}</option>
                <option value="off">{{ _('Off') }}</option>
              </select>
              <small class="text-muted">
                {{ _('Select the light status.') }}
              </small>
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_high_door_status">{{ _('Door status') }}</label>
              <select class="select2" id="area_alarm_high_door_status" name="high_door_status" data-placeholder="{{ _('Select a state') }}" style="width: 100%;">
                <option value="ignore">{{ _('Ignored') }}</option>
                <option value="open">{{ _('Open') }}</option>
                <option value="closed">{{ _('Closed') }}</option>
              </select>
              <small class="text-muted">
                {{ _('Select the door status.') }}
              </small>

            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-2 col-lg-2">
            <div class="form-group">
              <label for="area_alarm_high_trigger_threshold">{{ _('Alarm threshold') }}</label>
              <input type="number" step="1" min="0" class="form-control" id="area_alarm_high_trigger_threshold" value="0" name="high_trigger_threshold" placeholder="{{ _('Threshold') }}">
              <small class="text-muted">
                {{ _('Enter the amount of alarms before action take place.') }}
              </small>
              <div class="invalid-feedback">
                {{ _('Please enter a minimum value of %s.') % ('0',) }}
              </div>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="area_alarm_high_relays">{{ _('Relays') }}</label>
              <select class="select2" id="area_alarm_high_relays" name="high_relays" multiple="multiple" data-placeholder="{{ _('Select relays') }}" style="width: 100%;"> </select>
              <small class="text-muted">
                {{ _('Select the relays to toggle.') }}
              </small>
            </div>
          </div>
        </div>
        <div class="row area_alarm_high_dimmer_settings fuckbs-d-none">
          <ul class="nav nav-tabs mb-2" id="area_dimmer_settings_high_relays" role="tablist"> </ul>
          <div class="tab-content" id="area_dimmer_settings_high_relays_content"> </div>
        </div>
      </div>
      <div class="tab-pane fade" id="area_variation" role="tabpanel" aria-labelledby="variation-tab">
        <div class="row text-muted">
          <div class="col">
            <small class="text-muted">
              {{ _('Here you can enter periods where the sensors will change their values according to the list below. Make sure the periods are in chronological order!') }}
            </small>
          </div>
        </div>
        <div class="row">
          <div class="col-3 col-sm-3 col-md-3 col-lg-3">
            <div class="form-group">
              <label for="variation_when">{{ _('Source') }}</label>
            </div>
          </div>
          <div class="col-4 col-sm-4 col-md-4 col-lg-4 variation_time_settings">
            <div class="form-group">
              <label for="alarm_low_end">{{ _('Period/duration') }}</label>
            </div>
          </div>
          <div class="col-7 col-sm-7 col-md-7 col-lg-7 variation_external_source" style="display:none">
            <div class="form-group">
              <label for="alarm_low_end">{{ _('External source url') }}</label>
            </div>
          </div>
          <div class="col-2 col-sm-2 col-md-2 col-lg-2 variation_weather variation_external_source" style="display:none">
            <div class="form-group">
              <label for="alarm_low_end">{{ _('Offset') }}</label>
            </div>
          </div>
          <div class="col-3 col-sm-3 col-md-3 col-lg-3 variation_time_settings">
            <div class="form-group">
              <label for="variant_value">{{ _('Value') }}</label>
            </div>
          </div>
          <div class="col-1 col-sm-1 col-md-1 col-lg-1 variation_time_settings">
            <div class="form-group">
              <label for="action">{{ _('Action') }}</label>
            </div>
          </div>
          <div class="col-1 col-sm-1 col-md-1 col-lg-1 variation_time_settings">
            <div class="form-group">
              <label for="action">&nbsp;</label>
            </div>
          </div>
        </div>
        <div id="variation_list">
        </div>
        <div class="row">
          <div class="col-3 col-sm-3 col-md-3 col-lg-3">
            <div class="form-group">
              <small class="text-muted">
                {{ _('After x minutes change to value or at exactly a time stamp.') }}
              </small>
            </div>
          </div>
          <div class="col-7 col-sm-7 col-md-7 col-lg-7 variation_external_source" style="display:none">
            <div class="form-group">
              <small class="text-muted">
                {{ _('Enter a full url to the external source according to the Remote data feature.') }}
              </small>
            </div>
          </div>
          <div class="col-2 col-sm-2 col-md-2 col-lg-2 variation_weather variation_external_source" style="display:none">
            <div class="form-group">
              <small class="text-muted">
                {{ _('Enter a negative or positive offset value.') }}
              </small>
            </div>
          </div>
          <div class="col-4 col-sm-4 col-md-4 col-lg-4 variation_time_settings">
            <div class="form-group">
              <small class="text-muted">
                {{ _('Enter a duration in minutes or the actual time of the day.') }}
              </small>
            </div>
          </div>
          <div class="col-3 col-sm-3 col-md-3 col-lg-3 variation_time_settings">
            <div class="form-group">
              <small class="text-muted">
                {{ _('Enter a negative or positive value for a relative action. A number is treated as an absolute value.') }}
              </small>
            </div>
          </div>
          <div class="col-1 col-sm-1 col-md-1 col-lg-1 variation_time_settings">
            <div class="form-group">
              <small class="text-muted">
                {{ _('Add a new row') }}
              </small>
            </div>
          </div>
          <div class="col-1 col-sm-1 col-md-1 col-lg-1 variation_time_settings">
            <div class="form-group">
              <small class="text-muted">
                {{ _('Remove row') }}
              </small>
            </div>
          </div>
        </div>
        <script type="text/html" id="variation">
          <div class="row">
            <div class="col-3 col-sm-3 col-md-3 col-lg-3">
              <div class="form-group">
                <select class="select2" name="variation_when" style="width: 100%;">
                  <option value="after">{{ _('After x minutes') }}</option>
                  <option value="at">{{ _('At time') }}</option>
                  <option value="weather">{{ _('Using current weather') }}</option>
                  <option value="external">{{ _('Use json source') }}</option>
                  <option value="script">{{ _('Use script') }}</option>
                </select>
                <div class="invalid-feedback">
                  {{ _('Select a valid option.') }}
                </div>
              </div>
            </div>
            <div class="col-7 col-sm-7 col-md-7 col-lg-7 variation_external_source" style="display:none">
              <div class="form-group">
                <input type="text" class="form-control" name="variation_source" placeholder="{{ _('Enter a full url, local json file or script file.') }}">
                <div class="invalid-feedback">
                  {{ _('Enter a valid url, local json file or script file.') }}
                </div>
              </div>
            </div>
            <div class="col-2 col-sm-2 col-md-2 col-lg-2 variation_external_source variation_weather" style="display:none">
              <div class="form-group">
                <input type="number" class="form-control" name="variation_offset" placeholder="{{ _('Offset') }}">
                <div class="invalid-feedback">
                  {{ _('Offset.') }}
                </div>
              </div>
            </div>
            <div class="col-4 col-sm-4 col-md-4 col-lg-4 variation_time_settings">
              <div class="form-group">
                <input type="text" class="form-control" name="variation_period" placeholder="{{ _('Enter a duration in minutes or time') }}">
                <div class="invalid-feedback">
                  {{ _('Enter a valid time.') }}
                </div>
              </div>
            </div>
            <div class="col-3 col-sm-3 col-md-3 col-lg-3 variation_time_settings">
              <div class="form-group">
                <input type="text" class="form-control" name="variation_value" placeholder="{{ _('Value') }}">
                <div class="invalid-feedback">
                  {{ _('Enter a valid duration in minutes.') }}
                </div>
              </div>
            </div>
            <div class="col-1 col-sm-1 col-md-1 col-lg-1 variation_time_settings">
              <div class="form-group">
                <button type="button" class="form-control"><i class="fas fa-plus"></i></button>
              </div>
            </div>
            <div class="col-1 col-sm-1 col-md-1 col-lg-1 variation_time_settings">
              <div class="form-group">
                <button type="button" class="form-control"><i class="fas fa-minus"></i></button>
              </div>
            </div>
          </div>
        </script>
      </div>
    </div>
  </div>
</div>
<script type="text/html" id="area_dimmer_setting_duration">
  <div class="row">
    <label class="col-sm-3 col-form-label">{{ _('Dimmer on duration') }}</label>
    <div class="col pt-2">
      <input class="range_slider" data-id="dimmer_field_on" data-slider-value="[0,30]" data-slider-min="0" data-slider-max="180" data-slider-step="1" type="text">
    </div>
    <label class="col-sm-3 col-form-label">{{ _('Dimmer of duration') }}</label>
    <div class="col">
      <div class="col pt-2">
        <input class="range_slider" data-id="dimmer_field_off" data-slider-value="[0,30]" data-slider-min="0" data-slider-max="180" data-slider-step="1" type="text">
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <small class="text-muted fuckbs-d-none">
        {{ _('Select the delay and duration for the dimmer to go to on or off in minutes. Max duration is 180 minutes.') }}
      </small>
    </div>
  </div>
</script>
<script type="text/html" id="area_relay_setting_duration">
  <div class="row">
    <label class="col-sm-3 col-form-label">{{ _('Relay delay on') }}</label>
    <div class="col pt-2">
      <input class="range_slider" data-id="dimmer_field_on" data-slider-value="0" data-slider-min="0" data-slider-max="180" data-slider-step="1" type="text">
    </div>
    <label class="col-sm-3 col-form-label">{{ _('Relay delay off') }}</label>
    <div class="col pt-2">
      <input class="range_slider" data-id="dimmer_field_off" data-slider-value="0" data-slider-min="0" data-slider-max="180" data-slider-step="1" type="text">
    </div>
  </div>
  <div class="row">
    <div class="col">
      <small class="text-muted fuckbs-d-none">
        {{ _('Select the delay in minutes that a relay waits before it turns on. Max delay is 180 minutes.') }}
      </small>
    </div>
  </div>
</script>
{% endblock %}

{% block modal_form_javascript_functions %}

function remove_relay_tab(form, part, relay_id) {
  let tabs  = form.find('#area_dimmer_settings_' + part + '_relays');
  let panels = form.find('#area_dimmer_settings_' + part + '_relays_content');

  panels.find('#dimmer_' + part + '_setting_' + relay_id).remove();
  tabs.find('#dimmer_' + part + '_setting_' + relay_id + '-tab').parent().remove();

}

function add_relay_tab(form, part, relay_id, relay_name, dimmer) {
  if (['day','night'].indexOf(part) == -1) {
    return;
  }

  let tabs  = form.find('#area_dimmer_settings_' + part + '_relays');
  let panels = form.find('#area_dimmer_settings_' + part + '_relays_content');

  form.find('div.row.area_alarm_' + part + '_dimmer_settings').show();

  let tab = jQuery('<li>').addClass('nav-item').prop('role','presentation').append(
    jQuery('<a>').addClass('nav-link').attr({'id' : 'dimmer_' + part + '_setting_' + relay_id + '-tab','href':'#dimmer_' + part + '_setting_' + relay_id, 'data-toggle':'tab','role':'tab','aria-controls':'dimmer_' + part + '_setting_' + relay_id, 'aria-selected' : 'true'}).append(
        jQuery('<i>').addClass('fas fa-bolt mr-1')
      ).append(relay_name)
  );

  let panel = jQuery('<div>').addClass('tab-pane fade').attr({'id' : 'dimmer_' + part + '_setting_' + relay_id, 'role':'tabpanel', 'aria-labelledby':'dimmer_' + part + '_setting_' + relay_id + '-tab'})
  let dimmer_field = jQuery('<div>').addClass('col');
  let dimmer_field_id = part + '_dimmer_step_' + relay_id;
  let template = '#area_dimmer_setting_step';

  if (['day','night'].indexOf(part) != -1) {
    if (dimmer) {
      dimmer_field_id = part + '_dimmer_duration_' + relay_id;
      template = '#area_dimmer_setting_duration'
    } else {
      dimmer_field_id = part + '_relay_delay_' + relay_id;
      template = '#area_relay_setting_duration'
    }
  }

  jQuery(dimmer_field).loadTemplate(jQuery(template), {
    dimmer_field:     dimmer_field_id,
    dimmer_field_on:  dimmer_field_id.replace(relay_id,'on_'+relay_id),
    dimmer_field_off: dimmer_field_id.replace(relay_id,'off_'+relay_id),
  },{ append: true, bindingOptions: {ignoreNull : true}});

  dimmer_field.find('input').each(function(counter,element){
    element.name = element.id;
  });

  panel.append(dimmer_field);
  tabs.append(tab);
  panels.append(panel);
  panel.find('.range_slider').bootstrapSlider({'formatter' :
    function(value) {
      if (undefined !== value.length && 2 == value.length) {
        return '{{ _('Delay') }}: ' + value[0] + ' {{ _('minutes')}}, Duration: ' + (value[1]-value[0]) + ' {{ _('minutes')}}';
      }
      return '{{ _('Delay') }}: ' + value + ' {{ _('minutes')}}'
    }
  });
}

function plus_minus_buttons(form) {

  form.find('div#area_variation button').off('click').on('click',function(event) {

    let active_row = null;
    jQuery(this).parentsUntil('div.row').each(function(){
      active_row = jQuery(this).parent();
    })

    let amount = form.find('div#area_variation div#variation_list div.row').length;

    if (jQuery(event.currentTarget).find('i').attr('class').indexOf('minus') != -1) {
      // Remove row only when there is still 1 left
      if (amount > 1) {
        active_row.remove();
      }
    } else {
      let html = jQuery('<div>');
      html.loadTemplate(jQuery('#variation'), {},{ append: true, bindingOptions: {ignoreNull : true}});
      active_row.after(html.find('div.row'));
    }

    plus_minus_buttons(form);
  });

  // toggle for weather or external
  form.find('select[name="variation_when"]').off('change').on('change',function(event) {
    let mode = jQuery(this).val();

    jQuery('div.variation_time_settings, div.variation_external_source, div.variation_weather').hide();
    if ('at' == mode || 'after' == mode) {
      jQuery('div.variation_time_settings').show()
    } else if ('weather' == mode) {
      jQuery('div.variation_weather').show()
    } else if ('external' == mode || 'script' == mode) {
      jQuery('div.variation_external_source').show()
    }

    jQuery('input[name="variation_source"]').prop('disabled', 'external' != mode && 'script' != mode);
    jQuery('input[name="variation_offset"]').prop('disabled', 'at' == mode || 'after' == mode);
    jQuery('input[name="variation_period"],[name="variation_value"]').prop('disabled', 'external' == mode || 'script' == mode || 'weather' == mode);
  });

  // Disable the weather and external source option when there are more then 1 row
  form.find('select[name="variation_when"] option[value="weather"],[value="external"]').prop('disabled', form.find('div#area_variation div#variation_list div.row').length > 1);
  form.find('div#variation_list select').select2();
}
{% endblock %}

{% block modal_form_javascript_pre %}
let area_types = {};
let relay_data = {};
let sensor_data = {};
let weather_data = {};

let {{modal_type}}_sensor_select = {{modal_type}}_form.find('select[id$="sensors"]');

// Area type toggle
{{modal_type}}_form.find('select#area_type').on('change',function() {
  {{modal_type}}_form.find('div.row.area_type').hide();
  {{modal_type}}_form.removeClass('was-validated');

  {{modal_type}}_form.find('div.row.area_type').find('input').prop('disabled',true);
  {{modal_type}}_form.find('div.row.area_type').find('select').prop('disabled',true);

  {{modal_type}}_sensor_select.prop('required',false);

  {{modal_type}}_form.find('div.row.area_type .col.area_watertank input').prop('required',false);

  {{modal_type}}_form.find('div.row.area_type.area_' + this.value).find('input').prop('disabled',false);
  if ('watertank' != this.value) {
    {{modal_type}}_form.find('div.row.area_type .col.area_watertank input').prop('disabled',true);
  } else {
    {{modal_type}}_form.find('div.row.area_type .col.area_watertank input').prop('required',true);
  }

  {{modal_type}}_form.find('div.row.area_type.area_' + this.value).find('select').prop('disabled',false);

  {{modal_type}}_sensor_select.find('option').remove();

  let valid_sensor_types = area_types[this.value]['sensors'];
  let sensor_list = {{modal_type}}_form.find('div.row.area_type.area_' + this.value + ' select[id$="sensors"]');
  jQuery.each(sensor_data,function(counter,sensor){
    if (valid_sensor_types.indexOf(sensor.type) != -1 ) {
      sensor_list.append(jQuery('<option>').attr('value',sensor.id).text(sensor.name));
    }
  });

  {{modal_type}}_form.find('div.row.area_type.area_' + this.value + ' select[id$="_mode"]').trigger('change');

  {{modal_type}}_form.find('.col.area_watertank').toggle('watertank' == this.value);
  {{modal_type}}_form.find('.col.area_all').toggle('watertank' != this.value);

  jQuery('div.row.area_' + this.value).show();
});

// Mode toggle
{{modal_type}}_form.find('select[id$="_mode"]').on('change',function() {
  let area_type = {{modal_type}}_form.find('select#area_type').val();

  // Make the sensors required
  {{modal_type}}_form.find('select[name="sensors"]').prop('required','sensors' == this.value);

  if ('disabled' == this.value) {
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input').prop('readonly',true);
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' select:not(#' + this.id + ')').prop('readonly',true);

  } else if ('timer' == this.value) {

    // Enable timer fields
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input').prop('readonly',false);

    // Make the timers required
    // Only make the pane timers required, if there are relays selected in the same pane
    // Alarm low pane.
    {{modal_type}}_form.find('div.tab-pane[id$="_alarm_low"]  input[type!="search"]').prop('required',{{modal_type}}_form.find('div.tab-pane[id$="_alarm_low"]  select[id$="_alarm_low_relays"]  option:selected').length > 0);
    // Alarm high pane.
    {{modal_type}}_form.find('div.tab-pane[id$="_alarm_high"] input[type!="search"]').prop('required',{{modal_type}}_form.find('div.tab-pane[id$="_alarm_high"] select[id$="_alarm_high_relays"] option:selected').length > 0);

    // Disable hours fields
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id*="_hours"]').prop('readonly',true);

  } else if ('sensors' == this.value) {
    // Enable fields
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input').prop('readonly',false);

    //{{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id*="_hours"]').prop('readonly',true);

    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_begin"]').prop('readonly',true);
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_end"]').prop('readonly',true);
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_on_duration"]').prop('readonly',true);
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_off_duration"]').prop('readonly',true);

  } else if ('weather' == this.value || 'weather_inverse' == this.value) {
    let sunrise        = moment(weather_data.sun.rise * 1000).format('HH:mm');
    let sunset         = moment(weather_data.sun.set  * 1000).format('HH:mm');
    let duration_day   = formatNumber(moment.duration(weather_data.sun.set - weather_data.sun.rise, 'seconds').asMinutes(),0,1);
    let duration_night = formatNumber(moment.duration(weather_data.sun.rise - weather_data.sun.set, 'seconds').add(moment.duration(1,'d')).asMinutes(),0,1);

    if ('weather_inverse' == this.value) {
      let temp = sunrise;
      sunrise = sunset;
      sunset = temp;

      temp = duration_day;
      duration_day = duration_night;
      duration_night = temp;
    }

    // Enable hours fields
    {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id*="_hours"]').prop('readonly',false);

    if (['lights','audio'].indexOf(area_type) != -1) {
      // Day part
      // Set the day begin time
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_day_begin"]').val(sunrise).prop('readonly',true);

      // Set the day end time
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_day_end"]').val(sunset).prop('readonly',true);

      // Set the day on duration time (full day light period)
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_day_on_duration"]').val(duration_day).prop('readonly',true);

      // Set the day off duration time
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_day_off_duration"]').val(0).prop('readonly',true);

      // Night part
      // Set the night begin time
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_night_begin"]').val(sunset).prop('readonly',true);

      // Set the night end time
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_night_end"]').val(sunrise).prop('readonly',true);


      // Set the day on duration time (full day light period)
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_night_on_duration"]').val(duration_night).prop('readonly',true);
      // Set the day off duration time
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_night_off_duration"]').val(0).prop('readonly',true);

    } else {
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_low_begin"]').val(sunrise).prop('readonly',true);
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_low_end"]').val(sunset).prop('readonly',true);
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_low_on_duration"]').val(duration_day).prop('readonly',true);
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_low_off_duration"]').val(0).prop('readonly',true);
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_high_begin"]').val(sunset).prop('readonly',true);
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_high_end"]').val(sunrise).prop('readonly',true);
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_high_on_duration"]').val(duration_night).prop('readonly',true);
      {{modal_type}}_form.find('div.row.area_type.area_' + area_type + ' input[id$="_high_off_duration"]').val(0).prop('readonly',true);
    }
  }
});

// Enable/disable sensor variations
{{modal_type}}_form.find('.row.area_type select[id$="sensors"]').on('change',function(event) {
  jQuery('div#area_variation input').prop('readonly',jQuery(this).val().length == 0);
  jQuery('div#area_variation select').prop('readonly',jQuery(this).val().length == 0);
});

// Dimmer step settings for heating, humidity, etc
{{modal_type}}_form.find('.row.area_type select[id$="relays"]').on('change',function(event) {

  let target = jQuery(event.target);
  let active = [];
  if (target.data('active') !== undefined && target.data('active') != '') {
    active = target.data('active').split(',');
  }
  let selected      = target.val();
  let part          = target.attr('name').split('_')[0];
  let light_modus   = ['day','night'].indexOf(part) != -1;
  let dimmer_active = false;


  // Only make the pane timers required, if there are relays selected in the same pane
  // Alarm low pane.
  {{modal_type}}_form.find('div.tab-pane[id$="_alarm_low"]  input[type!="search"]').prop('required',{{modal_type}}_form.find('div.tab-pane[id$="_alarm_low"]  select[id$="_alarm_low_relays"]  option:selected').length > 0);
  // Alarm high pane.
  {{modal_type}}_form.find('div.tab-pane[id$="_alarm_high"] input[type!="search"]').prop('required',{{modal_type}}_form.find('div.tab-pane[id$="_alarm_high"] select[id$="_alarm_high_relays"] option:selected').length > 0);

  if (!light_modus) {
    return;
  }

  jQuery.each(Array.from(new Set(active.concat(selected))), function(counter,relay_id) {
    if (active.indexOf(relay_id) == -1) {
      // Add tab
      add_relay_tab({{modal_type}}_form, part, relay_id, relay_data[relay_id].name, relay_data[relay_id].dimmer);
    } else if (selected.indexOf(relay_id) == -1) {
      // Remove tab
      remove_relay_tab({{modal_type}}_form, part, relay_id);
    }
  });
  {{modal_type}}_form.find('#area_dimmer_settings_' + part + '_relays a:last').tab('show');
  target.data('active', selected.join(','));

});
{% endblock %}

{% block modal_form_javascript_load %}
jQuery('.area_type').hide();

// We load the weather data in a own call, as this can give a 404 error when no data information is available
jQuery.get({url: '{{ url_for("api:weather") }}', cache: '1' != Cookies.get('no-cache')}).then(function(data) {
  weather_data = data;
  {{modal_type}}_form.find('select[name="mode"] option[value^="weather"]').prop('disabled',false);
}).fail(function(data){
  // 404 error means that there is no weather data, so disable the weather timer options
  {{modal_type}}_form.find('select[name="mode"] option[value^="weather"]').prop('disabled',true);
}),

jQuery.when(

  jQuery.get('{{ url_for("api:area_types") }}'),
  jQuery.get('{{ url_for("api:enclosure_list") }}'),
  jQuery.get('{{ url_for("api:relay_list") }}'),
  jQuery.get('{{ url_for("api:sensor_list") }}'),
  jQuery.get('{{ url_for("api:audio_hardware") }}'),
  jQuery.get('{{ url_for("api:playlist_list") }}'),

).done(function(areas, enclosures, relays, sensors, soundcards, playlists) {

  jQuery.each(areas[0].data,function(counter,item){
    area_types[item.type] = item;
  });

  let {{modal_type}}_area_select = {{modal_type}}_form.find('select#area_type');
  {{modal_type}}_area_select.prop('disabled', false).attr('readonly', false).find('option').remove();

  jQuery.each(area_types,function(counter,item){
    {{modal_type}}_area_select.append(jQuery('<option>').attr('value',item.type).text(item.name));
  });

  let {{modal_type}}_enclosure_select = {{modal_type}}_form.find('select#area_enclosure');
  {{modal_type}}_enclosure_select.prop('disabled', false).attr('readonly', false).find('option').remove();

  jQuery.each(enclosures[0].data,function(counter,item){
    {{modal_type}}_enclosure_select.append(jQuery('<option>').attr('value',item.id).text(item.name));
  });

  // Check if we are adding an area from selected enclosure.
  if (jQuery(event.relatedTarget).data('enclosureid') !== undefined) {
    {{modal_type}}_enclosure_select.val(jQuery(event.relatedTarget).data('enclosureid'));
  }

  let {{modal_type}}_soundcard_select = {{modal_type}}_form.find('select#area_audio_soundcard');
  {{modal_type}}_soundcard_select.prop('disabled', false).attr('readonly', false).find('option').remove();
  jQuery.each(soundcards[0].data,function(counter,item){
    {{modal_type}}_soundcard_select.append(jQuery('<option>').attr('value',item.index).text(item.name));
  });
  {{modal_type}}_soundcard_select.trigger('change');


  let {{modal_type}}_playlist_select = {{modal_type}}_form.find('select[id$="playlists"]');
  {{modal_type}}_playlist_select.prop('disabled', false).attr('readonly', false).find('option').remove();
  jQuery.each(playlists[0].data,function(counter,item){
    {{modal_type}}_playlist_select.append(jQuery('<option>').attr('value',item.id).text(item.name));
  });
  {{modal_type}}_playlist_select.trigger('change');


  let {{modal_type}}_relay_select = {{modal_type}}_form.find('select[id$="relays"]');
  {{modal_type}}_relay_select.prop('disabled', false).data('active','').find('option').remove();

  // Store which relays are dimmers
  relay_data = [];
  jQuery.each(relays[0].data,function(counter,item){
    relay_data[item.id] = item;
    {{modal_type}}_relay_select.append(jQuery('<option>').attr('value',item.id).text(item.name));
  });

  sensor_data = sensors[0].data;

  // Clear dimmer step settings
  {{modal_type}}_form.find('.area_alarm_day_dimmer_settings ul.nav').html('');
  {{modal_type}}_form.find('.area_alarm_day_dimmer_settings div.tab-content').html('');

  {{modal_type}}_form.find('.area_alarm_night_dimmer_settings ul.nav').html('');
  {{modal_type}}_form.find('.area_alarm_night_dimmer_settings div.tab-content').html('');


  {{modal_type}}_form.find('.area_alarm_low_dimmer_settings ul.nav').html('');
  {{modal_type}}_form.find('.area_alarm_low_dimmer_settings div.tab-content').html('');

  {{modal_type}}_form.find('.area_alarm_high_dimmer_settings ul.nav').html('');
  {{modal_type}}_form.find('.area_alarm_high_dimmer_settings div.tab-content').html('');

  // Clear variation data
  {{modal_type}}_form.find('div#variation_list').loadTemplate(jQuery('#variation'), {},{ append: false, bindingOptions: {ignoreNull : true}});
  plus_minus_buttons({{modal_type}}_form);

  {{modal_type}}_area_select.trigger('change');

  // Check if we are in edit mode.... and need to load more data....
  if ('#' != jQuery(event.relatedTarget).attr('href')) {
    // Load the button data
    let url = jQuery(event.relatedTarget).attr('href');
    jQuery.get(url, function(data){
      // Enable the hidden id field
      {{modal_type}}_form.find('input[name="id"]').prop('disabled',false)
      // Change the form url to an PUT (update)
      {{modal_type}}_form.attr({'method' : 'PUT', 'action' : url});

      {{modal_type}}_enclosure_select.attr('readonly', true);
      {{modal_type}}_area_select.attr('readonly', true);

      let parsed_data = { ...data };
      delete(parsed_data['setup']);

      jQuery.each(data.setup,function(key, values) {
        // Day / night or low / high  key
        if (typeof values === 'object' && !(values instanceof Array) && values !== null) {
          jQuery.each(values, function(subkey, value) {
            parsed_data[key + '_' + subkey] = value;
          })
        } else {
          parsed_data[key] = values;
        }
      });

      let dimmer_steps = [];
      // Load the button values in the form
      jQuery.each(parsed_data,function(key,value) {
        let field = {{modal_type}}_form.find('[name="' + key + '"]');

        if (field.attr('type') == 'checkbox') {
          field.prop('checked',(1 != value)).trigger('change');
          field.prop('checked',(1 == value)).trigger('change');
        } else {
          field.val(value).trigger('change');
          if (key.indexOf('_relays') != -1 && value != '') {
            // The relays are set/changed, so fill the extra tweaks fields
            jQuery.each(parsed_data, function(key2,value2) {

              if (key2.indexOf('dimmer_duration') != -1 || key2.indexOf('relay_delay') != -1) {
                if (key2.indexOf('dimmer_duration') != -1) {
                  value2 = value2.split(',')
                  value2 = [value2[0] * 1, value2[1] * 1];
                } else {
                  value2 *= 1;
                }
                dimmer_steps.push({
                  id : key2,
                  value: value2
                });
              }
            });
          }
        }
      });

      // Load the variation data...
      if (data.setup['variation'] !== undefined) {
        let variation_rows = data.setup['variation'].length;
        for (let x = 0; x < variation_rows; x++) {

          let row = jQuery('div#variation_list div.row:last');
          let variation = data.setup['variation'][x];

          row.find('[name="variation_when"]').val(variation['when']).trigger('change');
          if ('at' == variation['when']) {
            row.find('[name="variation_period"]').val(moment.unix(variation['period']).format('LT'));
          } else {
            row.find('[name="variation_period"]').val(variation['period']);
          }
          row.find('[name="variation_offset"]').val(variation['offset']);
          row.find('[name="variation_value"]').val(variation['value']);

          if (x < variation_rows-1) {
            row.find('button:first').click();
          }
        }
      }

      setTimeout(function(){
        jQuery.each(dimmer_steps,function(counter,data) {
          let field = {{modal_type}}_form.find('[name="' + data['id'] + '"]').bootstrapSlider();
          field.bootstrapSlider('setValue', data['value']);
        });
      },100);

      {{modal_type}}_form.find('select[id$="_mode"]').trigger('change');
      {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
    });
  } else {
    {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
  }
});
{% endblock %}

{% block modal_form_javascript_pre_submit %}
{% endblock %}

{% block modal_form_javascript_pre_submit_formdata %}
let exclude_field_names = ['id','mode','name','type','enclosure','setup'];
if (['lights','audio'].indexOf(form_data['type']) != -1) {
  form_data['setup'] = {'day': {}, 'night': {}}
} else {
  form_data['setup'] = {'low': {}, 'high': {}}
}
// We want to collect the variation fields, so we can overwrite it later on
form_data['setup']['variation'] = {}

jQuery.each(form_data,function(field_name, value) {
  // Exclude fields in array below from parsing
  if (exclude_field_names.indexOf(field_name) == -1) {
    let field_parts = field_name.split('_');
    if (form_data['setup'][field_parts[0]] !== undefined) {
      form_data['setup'][field_parts[0]][field_parts.slice(1).join('_')] = value;
    } else {
      form_data['setup'][field_name] = value;
    }
    delete(form_data[field_name])
  }
});

let variation = []
if (form_data['setup']['variation']['when'] !== undefined) {
  if (typeof form_data['setup']['variation']['when'] === 'string' || form_data['setup']['variation']['when'] instanceof String) {
    if ('weather' == form_data['setup']['variation']['when']) {
      variation.push({
        'when'   : form_data['setup']['variation']['when'],
        'offset' : form_data['setup']['variation']['offset']
      });
    } else if ( 'external' == form_data['setup']['variation']['when']) {
      variation.push({
        'when'   : form_data['setup']['variation']['when'],
        'source' : form_data['setup']['variation']['source'],
        'offset' : form_data['setup']['variation']['offset']
      });
    }
  } else {
    for (let x = 0; x < form_data['setup']['variation']['when'].length; x++) {
      if ('at' == form_data['setup']['variation']['when'][x]) {
        /* Parse the timestamp and convert to unix timestamp */
        let local_time = moment(form_data['setup']['variation']['period'][x],'LT', true);

        if (!local_time.isValid()) {
          {{modal_type}}_form.removeClass('was-validated');
          toastr.error('{{ _('Invalid timestamp in variation settings.') }}', '{{ _('Form error') }}');
          return false;
        }
        form_data['setup']['variation']['period'][x] = local_time.unix();
      }

      variation.push({
        'when'   : form_data['setup']['variation']['when'][x],
        'period' : form_data['setup']['variation']['period'][x],
        'value'  : form_data['setup']['variation']['value'][x]
      });
    }
  }
}

form_data['setup']['variation'] = variation;
{% endblock %}
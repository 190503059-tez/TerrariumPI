{# Include the modal base html template #}
{% extends "layouts/modal.html" %}

{# Set some variables #}
{% set modal_size = 'modal-xl' %}
{% set modal_type = 'relay' %}
{% set modal_form_add_action  = url_for('api:relay_add') %}
{% set modal_form_edit_action = url_for('api:relay_update',relay='_id_') %}
{% set modal_reload_url = url_for('page', page='relays') %}

{% block modal_title %}<i class="fas fa-thumbtack mr-2" ></i>{{ _('Relay settings') }}{% endblock %}
{% block modal_body %}
<input type="hidden" name="id" id="relay_id" value="" disabled="disabled">
<div class="row">
  <div class="col-12 col-sm-6 col-md-4 col-lg-2">
    <div class="form-group">
      <label for="relay_hardware">Hardware</label>
      <div class="select2-primary">
        <select class="select2" id="relay_hardware" name="hardware" required="required" data-placeholder="Select hardware" style="width: 100%;">
        </select>
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-12 col-md-4 col-lg-3">
    <div class="form-group">
      <label for="relay_address">Address</label>
      <input type="text" class="form-control" id="relay_address" name="address" required="required" placeholder="Enter address">
    </div>
  </div>
  <div class="col-10 col-sm-10 col-md-8 col-lg-3">
    <div class="form-group">
      <label for="relay_name">Naam</label>
      <input type="text" class="form-control" id="relay_name" name="name" required="required" placeholder="Enter name">
    </div>
  </div>
  <div class="col-6 col-sm-6 col-md-6 col-lg-1">
    <div class="form-group">
      <label for="wattage">Wattage</label>
      <input type="number" step="0.001" min=0 class="form-control" id="wattage" name="wattage" required="required" placeholder="Wattage when powered on">
    </div>
  </div>
  <div class="col-6 col-sm-6 col-md-6 col-lg-1">
    <div class="form-group">
      <label for="flow" class="text-nowrap">Water flow</label>
      <input type="number" step="0.001" min=0 class="form-control" id="flow" name="flow" required="required" placeholder="Water flow in liters per minute when powered on">
    </div>
  </div>
  <div class="col-12 col-sm-12 col-md-12 col-lg-1">
    <div class="form-group">
      <span class="switch">
        <label for="manual_mode">Manual m.</label>
        <input type="checkbox" class="switch" id="manual_mode" name="manual_mode">
        <label for="manual_mode" class="mt-1"></label>
      </span>
    </div>
  </div>
  <div class="col-2 col-sm-2 col-md-4 col-lg-1">
    <div class="form-group">
      <label for="relay_current">Current</label>
      <input type="text" readonly="readonly" class="form-control" name="value" id="relay_current" placeholder="Current value">
    </div>
  </div>
</div>
<div class="row dimmer_callibration" style="display:block">
  <a data-toggle="collapse" href="#dimmer_callibration" role="button" aria-expanded="false" aria-controls="dimmer_callibration"><hr class="hr-text" data-content="{{ _('calibration') }}"></a>
  <div class="col">
    <div class="collapse row pt-3" id="dimmer_callibration">
      <div class="col-6 col-sm-6 col-md-6 col-lg-2">
        <div class="form-group">
          <label for="dimmer_frequency">Dimmer frequency in Hz</label>
          <input type="number" step="1" min="100" max="10000" class="form-control" id="dimmer_frequency" name="dimmer_frequency" placeholder="Dimmer frequency in Hz" value="10000">
        </div>
      </div>
      <div class="col-6 col-sm-6 col-md-6 col-lg-2">
        <div class="form-group">
          <label for="dimmer_max_power">Max power in %</label>
          <input type="number" step="1" min="1" max="100" class="form-control" id="dimmer_max_power" name="dimmer_max_power" placeholder="Max power in percentage" value="100">
        </div>
      </div>
      <div class="col-6 col-sm-6 col-md-6 col-lg-2">
        <div class="form-group">
          <label for="dimmer_offset">Dimmer offset in %</label>
          <input type="number" step="1" min="0" max="100" class="form-control" id="dimmer_offset" name="dimmer_offset" placeholder="Dimmer offset in percentage" value="0">
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block modal_form_javascript_functions %}
{% endblock %}

{% block modal_form_javascript_pre %}
{{modal_type}}_form.find('select#relay_hardware').on('change',function() {
  {{modal_type}}_form.find('.dimmer_callibration').toggle(this.value.indexOf('-dimmer') != -1);
  {{modal_type}}_form.find('div#dimmer_callibration div:first').toggle(this.value != 'brightpi-dimmer');

  // Disable the dimmer calibration fields...
  {{modal_type}}_form.find('input[name="dimmer_frequency"]').prop('disabled',this.value.indexOf('-dimmer') == -1);
  {{modal_type}}_form.find('input[name="dimmer_max_power"]').prop('disabled',this.value.indexOf('-dimmer') == -1);
});
{% endblock %}

{% block modal_form_javascript_load %}
jQuery.get('{{ url_for("api:relay_hardware") }}', function(data) {
    let relay_hardware_select = {{modal_type}}_form.find('select#relay_hardware');
    relay_hardware_select.attr('readonly', false);
    relay_hardware_select.find('option').remove();

    jQuery.each(data.data,function(counter,item){
        relay_hardware_select.append(jQuery('<option>').attr('value',item.hardware).text(item.name));
    });

    relay_hardware_select.trigger('change');

    // Check if we are in edit mode.... and need to load more data....
    if ('#' != jQuery(event.relatedTarget).attr('href')) {
      // Load the relay data
      let url = jQuery(event.relatedTarget).attr('href');

      jQuery.get(url, function(data){
        // Enable the hidden id field
        {{modal_type}}_form.find('input[name="id"]').prop('disabled',false)
        // Change the form url to an PUT (update)
        {{modal_type}}_form.attr({'method' : 'PUT', 'action' : url});
        // Make hardware type readonly
        relay_hardware_select.attr('readonly', true);

        // Load the relay values in the form
        jQuery.each(data,function(key,value) {
          if ('calibration' == key && value != null) {
            for (const [ calibration_key, calibration_value ] of Object.entries(value)) {
              let field = {{modal_type}}_form.find('[name="' + calibration_key + '"]');
              field.val(calibration_value).trigger('change');
            }
          }

          let field = {{modal_type}}_form.find('[name="' + key + '"]');
          if (field.attr('type') == 'checkbox') {
            field.prop('checked',(1 != value)).trigger('change');
            field.prop('checked',(1 == value)).trigger('change');
          } else {
            field.val(value).trigger('change');
          }
        });
        {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
      });
    } else {
      {{modal_type}}_modal.find('div.loading').removeClass('d-flex').hide();
    }
  });
{% endblock %}

{% block modal_form_javascript_pre_submit_formdata %}
form_data['calibration'] = {}
if (form_data['hardware'].indexOf('-dimmer') != -1) {
  // Set the calibration JSON
  try {
    form_data['calibration']['dimmer_frequency'] = form_data['dimmer_frequency'];
    delete(form_data['dimmer_frequency']);
  } catch (error) { }

  try {
    form_data['calibration']['dimmer_max_power'] = form_data['dimmer_max_power'];
    delete(form_data['dimmer_max_power']);
  } catch (error) { }

  try {
    form_data['calibration']['dimmer_offset'] = form_data['dimmer_offset'];
    delete(form_data['dimmer_offset']);
  } catch (error) { }
}
{% endblock %}
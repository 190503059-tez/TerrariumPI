{% extends "layouts/base-content.html" %}
{% block title %}{{ _('Audio files') }}{% endblock %}
{% block page_content %}
<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mr-1"><i class="fas fa-file-audio mr-2" data-class="icon"></i>{{ _('Audio files') }}</h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <table id="audio_files" class="table table-bordered table-striped table-hover">
              <thead>
              <tr>
                <th>{{ _('Name') }}</th>
                <th>{{ _('Duration') }}</th>
                <th>{{ _('Filename') }}</th>
                <th>{{ _('Size') }}</th>
                <th>{{ _('Action') }}</th>
              </tr>
              </thead>
              <tbody>
              </tbody>
              <tfoot>
                <tr>
                  <th>{{ _('Name') }}</th>
                  <th>{{ _('Duration') }}</th>
                  <th>{{ _('Filename') }}</th>
                  <th>{{ _('Size') }}</th>
                  <th>{{ _('Action') }}</th>
                </tr>
                </tfoot>
            </table>
            <div class="{% if not authenticated %}disabled{% endif %}" {% if not authenticated %}title="{{ _('Login to make changes') }}"{% endif %}>
              <div class="input-group mt-3">
                <div class="input-group-prepend">
                  <span class="input-group-text" id="upload_new_file_label">{{ _('Upload new audio file') }}</span>
                </div>
                <div class="custom-file">
                  <form id="audio_upload" method="post" action="{{ url_for('api:audiofile_add') }}" enctype="multipart/form-data" >
                    <input type="file" name="audiofiles" accept=".aac,.mp3,.ogg,.wav,.m4a,.flac" multiple="true" class="custom-file-input" id="upload_new_file" aria-describedby="upload_new_file_label" {% if not authenticated %}disabled="disabled"{% endif %}>
                    <label class="custom-file-label" for="upload_new_file">{{ _('Choose a file') }}</label>
                  </form>
                </div>
              </div>
              <div class="progress progress-xs active mt-2 upload_progress" style="display:none">
                <div class="progress-bar bg-success progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                  <span class="sr-only"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
  jQuery(function () {
    jQuery('#audio_files').DataTable({
      responsive: true,
      autoWidth: false,
      language: {
        url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/{{ lang[:2].lower() }}-{{ lang[3:].upper() }}.json'
      },
      ajax: {
        url: '{{ url_for("api:audiofile_list") }}',
        dataSrc: function (json) {
          let data = json.data;
          let return_data = new Array();

          for(let i = 0; i < data.length; i++){
            let audio_player_icon = jQuery('<button>').addClass('btn btn-light btn-sm text-primary audio_player').append(jQuery('<i>').addClass('fas fa-play-circle'));
            let audio_player = jQuery('<audio>').prop({'controls':true, 'preload' : 'none'}).addClass('d-none').append(jQuery('<source>').attr('src','/media/' + data[i].filename.split(/[\\/]/).pop()));

            {% if authenticated %}
            let delete_icon = jQuery('<a>').addClass('btn btn-light btn-sm text-danger').attr({'href':'{{ url_for("api:audiofile_delete", audiofile="_id_") }}'.replace('_id_',data[i].id) , 'title' : '{{ _('Delete audio file') }} ' + data[i].name, 'data-action':'DELETE','data-toggle':'modal','data-target':'#modal-confirm'}).append(jQuery('<i>').addClass('fas fa-trash-alt'));
            {% endif %}

            return_data.push({
              filename : data[i].filename.split('/').pop(),
              filesize : formatBytes(data[i].filesize),
              duration : moment.duration(data[i].duration,'seconds').humanize(),
              name     : data[i].name,
              action   : audio_player_icon.prop('outerHTML') + audio_player.prop('outerHTML'){% if authenticated %} + ' ' + delete_icon.prop('outerHTML'){% endif %}
            });
          }
          return return_data;
        }
      },

      columns: [
        { data: 'name' },
        { data: 'duration' },
        { data: 'filename' },
        { data: 'filesize' },
        { data: 'action', class: 'd-flex justify-content-around' },
      ]
    }).on('draw', function(event, settings){
      jQuery('button.audio_player').off('click').on('click',function(element) {
        let player_icon = jQuery(element.currentTarget);
        let player = player_icon.siblings('audio');

        if (player_icon.find('i').hasClass('fa-play-circle')) {
          // Start the player
          player[0].play();
          player_icon.find('i').removeClass('fa-play-circle').addClass('fa-pause-circle');
        } else {
          // Stop the player
          player[0].pause();
          player_icon.find('i').removeClass('fa-pause-circle').addClass('fa-play-circle');
        }
      });
    });

    {% if authenticated %}
    function isAudioFile(file) {
      const ext = ['.aac', '.mp3', '.ogg', '.wav', '.m4a', '.flac'];
      return ext.some(el => file.endsWith(el));
    }

    jQuery('form#audio_upload input').on('change',function(event){
      let formData = new FormData();

      jQuery.each(this.files,function(index,file){
        if (isAudioFile(file.name)) {
          formData.append('audiofiles', file);
        } else {
          toastr.warning('{{ _('Audio file {file} is not valid.') }}'.replace('{file}',file.name), '{{ _('Warning') }}');
        }
      });

      if (Array.from(formData.entries()).length == 0) {
        toastr.error('{{ _('Uploaded files are not valid.') }}', '{{ _('Error') }}');
        return;
      }

      jQuery('.upload_progress').toggle().find('div.progress-bar').css('width', '0%');
      jQuery.ajax({
        url: '{{ url_for('api:audiofile_add') }}',
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        xhr: function() {
          let xhr = new window.XMLHttpRequest();
          xhr.upload.addEventListener("progress", function(evt) {
            if (evt.lengthComputable) {
              let percentComplete = evt.loaded / evt.total;
              jQuery('.upload_progress div.progress-bar').css('width',Math.round(percentComplete * 100)+ '%');
              if (percentComplete == 1) {
                toastr.success('{{ _('Audio file is being processed. Please wait...') }}', '{{ _('OK') }}');
              }
            }
          }, false);
          return xhr;
        },
        success: function (result) {
          toastr.success('{{ _('Audio files are uploaded.') }}', '{{ _('OK') }}');
          load_page();
        },
        error: function (error) {
          console.log(error);
        }
      });
    });
    {% endif %}
  });
</script>
{% endblock page_content %}

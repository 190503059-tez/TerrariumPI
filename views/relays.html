{% extends "layouts/base-content.html" %}
{% block title %}{{ _('Relays') }}{% endblock %}
{% block page_content %}
<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    <!-- Main row -->
    <div class="row">
      <div style="width: 80%; text-align: center; margin: 5% 30%" class="zero_message fuckbs-d-none">
        <div class="callout callout-info">
          <h5>{{ _('No relays') }}</h5>
          <p class="pt-3">
            {% if authenticated %}
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-relay-setup" >{{ _('Add new relay') }}</button>
            {% else %}
            <a href="{{ url_for('login') }}" class="text-primary">{{ _('Please login to make changes') }}</a>
            {% endif %}
          </p>
        </div>
      </div>
      <!-- Left col -->
      <div class="col" id="relay_list">
        <script type="text/html" id="relay_template">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title mr-1">
                <i class="fas fa-fw fa-bolt mr-2"></i><span data-content="name">...</span>
                <small class="ml-2 text-muted">{{ _('Last update') }}: <span class="last_update"  data-template-bind='[
                  {"attribute": "content", "value": "last_update", "formatter": "datetimeformatter", "formatOptions": "LLLL"} ]'
                ></span></small>
              </h3>
              <small data-template-bind='[
                  {"attribute": "class", "value": "error", "formatter": "prefixer", "formatOptions": "badge badge-danger "} ]'
              >{{ _('error') }}</small>
              <small class="badge badge-warning fuckbs-d-none">{{ _('warning') }}</small>
              <small class="badge badge-primary" data-template-bind='[
              {"attribute": "class", "value": "manual", "formatter": "prefixer", "formatOptions": "badge badge-primary "} ]'
              >{{ _('Manual mode') }}</small>
              <div class="card-tools">
                <div class="btn-group">
                  <button type="button" class="btn btn-tool dropdown-toggle" data-toggle="dropdown">
                    <i class="fas fa-calendar-alt"></i>
                  </button>
                  <div class="dropdown-menu dropdown-menu-right" role="menu">
                  </div>
                </div>
                <div class="btn-group">
                  <button type="button" class="btn btn-tool dropdown-toggle" data-toggle="dropdown">
                    <i class="fas fa-wrench"></i>
                  </button>
                  <div class="dropdown-menu dropdown-menu-right" role="menu">
                    {% if authenticated %}
                    <a data-href="export_link" data-id="id" class="dropdown-item export_link" data-template-bind='[
                    {"attribute": "title", "value": "name", "formatter": "prefixer", "formatOptions": "{{ _('Export relay') }} "} ]'>
                    <i class="fas fa-file-export mr-1"></i> {{ _('Export') }}
                    </a>
                    <a data-href="edit_link" data-id="id" class="dropdown-item" data-toggle="modal" data-target="#modal-relay-setup" data-template-bind='[
                    {"attribute": "title", "value": "name", "formatter": "prefixer", "formatOptions": "{{ _('Edit relay') }} "} ]'>
                      <i class="fas fa-wrench mr-1"></i> {{ _('Settings') }}
                    </a>
                    <a href="#replace_hardware" data-id="id" class="dropdown-item" data-template-bind='[
                    {"attribute": "title", "value": "name", "formatter": "prefixer", "formatOptions": "{{ _('Replace hardware') }} "} ]'>
                      <i class="fas fa-tools mr-1"></i> {{ _('Replace hardware') }}
                    </a>
                    <a data-href="manual_mode_link" data-id="id" class="dropdown-item" data-action="POST" data-field="value" data-toggle="modal" data-target="#modal-confirm" data-template-bind='[
                    {"attribute": "title", "value": "name", "formatter": "prefixer", "formatOptions": "{{ _('Manual mode relay') }} "} ]'>
                      <i class="fas fa-hand-paper mr-1"></i> {{ _('Manual mode') }}
                    </a>
                    <a data-href="ignore_link" data-id="id" class="dropdown-item" data-action="PUT" data-field="value" data-toggle="modal" data-target="#modal-confirm" data-template-bind='[
                    {"attribute": "title", "value": "name", "formatter": "prefixer", "formatOptions": "{{ _('Ingore relay') }} "} ]'>
                      <i class="fas fa-ban mr-1"></i> {{ _('Ignore') }}
                    </a>
                    <a data-href="delete_link" data-id="id" class="dropdown-item" data-action="DELETE" data-toggle="modal" data-target="#modal-confirm" data-template-bind='[
                    {"attribute": "title", "value": "name", "formatter": "prefixer", "formatOptions": "{{ _('Delete relay') }} "} ]'>
                      <i class="fas fa-trash-alt mr-1"></i> {{ _('Delete') }}
                    </a>
                    {% else %}
                      <a href="{{ url_for('login') }}" class="dropdown-item">{{ _('Login to make changes') }}</a>
                    {% endif %}
                  </div>
                </div>
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                  <i class="fas fa-minus"></i>
                </button>
                <button type="button" class="btn btn-tool" data-card-widget="remove">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body p-0">
              <div class="d-md-flex">
                <div class="col-12 col-sm-12 col-md-3 col-lg-2 text-center">
                  <button type="button" data-title="toggle_title" class="btn btn-default mt-2 mb-2 text-secondary" data-id="relay" disabled="disabled">
                    <i class="fas fa-power-off" data-class="powered" style="font-size: 9rem;"></i>
                  </button>
                  <input type="text" class="dial" value="0" data-width="170" data-height="170" data-value="value" data-id="dimmer" data-min="0" data-max="100" data-angleArc="290" data-angleOffset="35">
                </div>
                <div class="col-12 col-sm-12 col-md-9 col-lg-10">
                  <div class="overlay">
                    <i class="fas fa-3x fa-sync-alt fa-spin"></i>
                  </div>
                  <canvas data-id="graph" class="graph"></canvas>
                </div>
              </div> <!-- /.d-md-flex -->
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </script>
      </div>
      <!-- /.col -->
    </div>
    <!-- /.row -->
  </div>
  <!--/. container-fluid -->
</section>
<!-- /.content -->
<script>
  jQuery(function () {
    jQuery.get('{{ url_for("api:relay_list") }}',function(data) {
      data = data.data;
      // Sort the relays based on the given relay name
      data.sort((a, b) => a.name.localeCompare(b.name));

      if (data.length > 0) {
        jQuery('.zero_message').remove();
      } else {
        jQuery('.zero_message').show();
      }

      jQuery.each(data,function(counter, relay) {
        relay.export_link      = '{{ url_for('api:relay_history',  relay='_id_', action="export") }}'.replace('_id_',relay.id);
        relay.edit_link        = '{{ url_for('api:relay_detail',   relay='_id_') }}'.replace('_id_',relay.id);
        relay.manual_mode_link = '{{ url_for('api:relay_manual',   relay='_id_') }}'.replace('_id_',relay.id);
        relay.delete_link      = '{{ url_for('api:relay_delete',   relay='_id_') }}'.replace('_id_',relay.id);
        relay.ignore_link      = '{{ url_for('api:setting_update', setting='exclude_ids') }}';

        relay.toggle_title     = {% if authenticated %}'{{ _('Toggle relay') }} ' + relay.name{% else %}'{{ _('Please login to make changes') }}'{% endif %};

        relay.powered = (relay.value > 0 ? 'text-success' : '');

        relay.error  = (relay.value != null ? 'fuckbs-d-none' : '');
        relay.manual = (!relay.manual_mode  ? 'fuckbs-d-none' : '');

        relay.relay  = (!relay.dimmer ? 'relay_' + relay.id : null);
        relay.dimmer = (relay.dimmer  ? 'relay_' + relay.id : null);
        relay.graph  = 'graph_' + relay.id;

        $('#relay_list').loadTemplate($('#relay_template'), relay, {append: true, bindingOptions: {ignoreNull : true}});






        // $('#relay_list').loadTemplate($('#relay_template'),{

        //   icon: 'fa-bolt',
        //   title: relay.name,
        //   last_update: moment().format('LLL'),

        //   //error_message : (relay.error ? 'error' : ''),
        //   badge_message: (relay.exclude_avg ? 'Excl. avg' : (relay.manual_mode ? 'Manual mode' : '')),
        //   power: (relay.value > 0 ? 'text-success' : ''),
        //   current: relay.value,

        //   relay_edit_link:        '{{ url_for('api:relay_detail', relay='_id_') }}'.replace('_id_',relay.id),
        //   relay_ignore_link:      '{{ url_for('api:setting_update', setting='exclude_ids') }}',
        //   relay_delete_link:      '{{ url_for('api:relay_delete', relay='_id_') }}'.replace('_id_',relay.id),
        //   relay_manual_mode_link: '{{ url_for('api:relay_manual', relay='_id_') }}'.replace('_id_',relay.id),
        //   relay_replace_hardware_link : '#replace_hardware',

        //   settings_title: 'Edit relay: ' + relay.name,
        //   ignore_title: 'Ignore relay: ' + relay.name,
        //   delete_title: 'Delete relay: ' + relay.name,
        //   toggle_title: {% if authenticated %}'Toggle relay ' + relay.name{% else %}'Please login to make changes'{% endif %},
        //   manual_title: 'Toggle manual mode',
        //   replace_title: 'Replace hardware',

        //   relay_id: relay.id,
        //   relay:  (!relay.dimmer ? 'relay_' + relay.id : null),
        //   dimmer: (relay.dimmer  ? 'relay_' + relay.id : null),

        //   graph: 'graph_' + relay.id
        // },{ append: true, bindingOptions: {ignoreNull : true}});

        new graph('graph_' + relay.id, '{{ url_for("api:relay_history", action="history", relay="_id_") }}'.replace('_id_',relay.id), relay.hardware);
      });

      jQuery(".dial").knob({
        format   : function(value) { return formatNumber(value) + '%' },
        fgColor  : get_template_color('text-success',false,true),
        bgColor  : get_template_color('text-secondary',false,true),
        readOnly : {% if authenticated %}false{%else%}true{%endif%},
        {% if authenticated %}
        'release' : function (value) {
          let old_value = this.val();
          let id = jQuery(this.i[0]).attr('id').replace('relay_','');
          let toggle_url = '{{ url_for("api:relay_action", relay="_id_", action="toggle") }}'.replace('_id_',id).replace('toggle',value);

          if (old_value != value) {
            jQuery.post(toggle_url,function(data){
              toastr.success('{{ _('Changed state of relay') }}: ' + data.name, '{{ _('OK') }}')
            }).fail(function(response) {
              toastr.error('{{ _('Could not change the relay state of') }}: ' + response.message, '{{ _('Change error') }}')
            });
          }
        },
        {% endif %}
      });

      jQuery('input.dial').siblings('canvas').addClass('border rounded p-2 relay{% if not authenticated %} disabled{% endif %}');

      {% if authenticated %}
      jQuery('button[id^="relay_"]').off('click').on('click',function() {
        let toggle_url = '{{ url_for("api:relay_action", relay="_id_", action="toggle") }}'.replace('_id_',this.id.replace('relay_',''));
        jQuery.post(toggle_url,function(data){
          toastr.success('{{ _('Changed state of relay') }}: ' + data.name, '{{ _('OK') }}')
        }).fail(function(response) {
          toastr.error('{{ _('Could not change the relay state of') }}: ' + response.message, '{{ _('Change error') }}')
        });
      }).prop('disabled','');
      {% endif %}
    });
  });
</script>
{% endblock page_content %}